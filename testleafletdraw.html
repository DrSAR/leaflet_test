<!DOCTYPE html>
<html>
  <head>
    <title>
      Leaflet Test
    </title>
    <meta charset="utf-8">
    <!--JS from Leaflet, version 1.4.0, as a local file-->
    <script type="text/javascript" src="leaflet.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js" integrity="sha256-6BZRSENq3kxI4YYBDqJ23xg0r1GwTHEpvp3okdaIqBw=" crossorigin="anonymous"--><!--/script-->
    <!--CSS from Leaflet, version 1.4.0-->
    <link rel="stylesheet" type="text/css" href="leaflet.css">
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css" integrity="sha256-YR4HrDE479EpYZgeTkQfgVJq08+277UXxMLbi/YP69o=" crossorigin="anonymous" /-->
    
    <!--js for drawing tools-->
    <script type="text/javascript" src="leaflet_draw.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha256-siofc4Uwjlra3YWkwthOn8Uj69cNN4aMug/iOHNiRgs=" crossorigin="anonymous"></script-->
    <!--css for drawing tools-->
    <link rel="stylesheet" type="text/css" href="leaflet-draw.css">
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha256-XzD3RpaHPv7lzX9qt+2n1j5cWj48O24KsgaGYpKN8x8=" crossorigin="anonymous" /-->
    
    <!--more JS-->
    <script type="text/javascript" src="jQuery_v3.4.0.js"></script>
    <!--script crossorigin="anonymous" integrity=
    "sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" src=
    "https://code.jquery.com/jquery-3.4.0.min.js"-->
    <!--/script-->

    <!-- TEST -->

    <link rel="stylesheet" href="Control.Opacity.css" />
    <script src="Control.Opacity.js"></script>

    <script src="OpacitySliderJQuery/jquery-1.9.1.js"></script>
    <script src="OpacitySliderJQuery/jquery-ui-1.10.3.custom.min.js"></script>
    <link rel="stylesheet" href="OpacitySliderJQuery/jquery-ui-1.10.3.custom.min.css" />

  </head>
  <body>
    <div id="serverstatus" style="height:5mm">
    </div>

    <!-- sliders -->
    <div style="width:100%; display: table;">
      <div style="display: table-row">
    <!-- slider group 1 -->
    <div class="slider">
      <div style="width: 600px; display: table-cell;">  
      <h4>Bottom Layer (Histolayer) Controls</h4>
      <!-- brightness slider -->
      <div id="brightnessSlider">
        <input type="range" min="0" max="200" value="100" class="slider" id="brightness-slider">
        <span>Brightness: </span><span id='brightness-value'>100%</span>
      </div>

      <!-- contrast slider -->
      <div id="contrastSlider">
        <input type="range" min="0" max="200" value="100" class="slider" id="contrast-slider">
        <span>Contrast: </span><span id='contrast-value'>100%</span>
      </div>

      <!-- opacity slider -->
      <div id="opacitySlider">
        <input type="range" min="0" max="100" value="100" class="slider" id="opacity-slider">
        <span>Bottom Map Opacity: </span><span id='opacity-value'>100%</span>
      </div>
      </div>
    </div>

    <!-- slider group 2 -->
    <div class="slider">
      <div style="display: table-cell;">  
      <h4>Top/Upper Layer Controls</h4>
      <!-- brightness slider 2 -->
      <div id="brightnessSlider2">
        <input type="range" min="0" max="200" value="100" class="slider" id="brightness-slider2">
        <span>Brightness: </span><span id='brightness-value2'>100%</span>
      </div>

      <!-- contrast slider -->
      <div id="contrastSlider2">
        <input type="range" min="0" max="200" value="100" class="slider" id="contrast-slider2">
        <span>Contrast: </span><span id='contrast-value2'>100%</span>
      </div>

      <!-- opacity slider -->
      <div id="opacitySlider2">
        <input type="range" min="0" max="100" value="100" class="slider" id="opacity-slider2">
        <span>Top Map Opacity: </span><span id='opacity-value2'>100%</span>
      </div>
      </div>
    </div>
  </div>
  </div>

    <div id="map" style="width: 100hh; height: 98vh; border: 1px solid #ccc">
    </div>

    <script>
    function postJSONData(JSONData, resID)
    {
        $.ajax({
          type: "POST",
          url: "https://git.sarlab.ca:5050/storeJSON/"+resID,
          contentType:"application/json",
          data:  JSONData
        })
        .done(function() {
          $("#serverstatus")[0].innerHTML = "SAVED";
        })
        .fail(function() {
          alert( "error" );
        })
        .always(function() {
          // whatever we'd do in all cases
        });
    };
    function getJSONData(resID, fGroup)
    {
        $.ajax({
          type: "GET",
          url: "https://cocalc.sarlab.ca:5050/readJSON/"+resID,
          dataType: 'json'
        })
        .done(function(data) {
          $("#serverstatus")[0].innerHTML = "Server Data Loaded.";
          L.geoJson(data["features"], {
            onEachFeature: function (feature, layer) {
              fGroup.addLayer(layer);
            }
          });
          $("#serverstatus")[0].innerHTML = "Loaded Annotations added to Image.";
        })
        .fail(function(data) {
          if (data['status'] == 404) {
            $("#serverstatus")[0].innerHTML = "No annotations found on Server.";
          } else {
            alert("Error Loading Data");
          };
        });
    }

    //create the map
    var bottomMap = new L.tileLayer('https://pfeifer.phas.ubc.ca/map/tiles/{z}/tile_{x}_{y}.png', {
      layers: 'BottomLayer',
      maxZoom: 7,
      minZoom: 1,
      format: 'image/png',
      transparent: true
    });
    
    var topMap = new L.tileLayer('./tiles/{z}/tile_{x}_{y}.png', {
      layers: 'TopLayer',
      maxZoom: 7,
      minZoom: 1,
      format: 'image/png',
      transparent: true
    });

    //TODO: for loop to apply blur effect to each tile
    //var topMapTiles = './tiles/{z}/tile_{x}_{y}.png';
    //for (tile in topMap.getTileLayer()) {
    //  tile.style.filter = "blur(50px)";
    //}

    var map = new L.map('map', {
        maxZoom: 7,
        minZoom: 1,
        crs: L.CRS.Simple,
        layers: [bottomMap, topMap],
        zoomControl: true
      }).setView([0,0], 1),
      drawnItems = L.featureGroup().addTo(map),
      sourcelabels = L.layerGroup().addTo(map),
      histolayer = L.tileLayer('https://pfeifer.phas.ubc.ca/map/tiles/{z}/tile_{x}_{y}.png', {
        attribution: 'AIMlab'}).addTo(map);

    //brightness and contrast slider, opacity slider for bottom layer
    histolayer.getContainer().style.filter = "brightness(100%)" + "contrast(100%)" + "opacity(100%)";
    var slider1 = document.getElementById("brightness-slider");
    var slider2 = document.getElementById("contrast-slider");
    var slider3 = document.getElementById("opacity-slider");
    
    var brightnessSpan = document.getElementById("brightness-value");
    var contrastSpan = document.getElementById("contrast-value");
    var opacitySpan = document.getElementById("opacity-value")

    var brightness = slider1.value;
    var contrast = slider2.value;
    var opacity = slider3.value;

    slider1.addEventListener("input", function (e) {
      brightness = e.target.value;
      brightnessSpan.textContent = brightness + "%";
      histolayer.getContainer().style.filter = "opacity(" + opacity + "%) brightness(" + this.value + "%) contrast(" + contrast + "%)";
    });
    slider2.addEventListener("input", function(e) {
      contrast = e.target.value;
      contrastSpan.textContent = contrast + "%";
      histolayer.getContainer().style.filter = "opacity(" + opacity + "%) brightness(" + brightness + "%) contrast(" + this.value + "%)";
    })
    slider3.addEventListener("input", function(e) {
      opacity = e.target.value;
      opacitySpan.textContent = opacity + "%";
      histolayer.getContainer().style.filter = "opacity(" + this.value + "%) brightness(" + brightness + "%) contrast(" + contrast + "%)";
    })

    //second group of sliders
    topMap.getContainer().style.filter = "brightness(100%)" + "contrast(100%)" + "opacity(100%)";
    var slider4 = document.getElementById("brightness-slider2");
    var slider5 = document.getElementById("contrast-slider2");
    var slider6 = document.getElementById("opacity-slider2");
    
    var brightnessSpan2 = document.getElementById("brightness-value2");
    var contrastSpan2 = document.getElementById("contrast-value2");
    var opacitySpan2 = document.getElementById("opacity-value2")

    var brightness2 = slider4.value;
    var contrast2 = slider5.value;
    var opacity2 = slider6.value;

    slider4.addEventListener("input", function (e) {
      brightness2 = e.target.value;
      brightnessSpan2.textContent = brightness2 + "%";
      topMap.getContainer().style.filter = "opacity(" + opacity2 + "%) brightness(" + this.value + "%) contrast(" + contrast2 + "%)";
    });
    slider5.addEventListener("input", function(e) {
      contrast2 = e.target.value;
      contrastSpan2.textContent = contrast2 + "%";
      topMap.getContainer().style.filter = "opacity(" + opacity2 + "%) brightness(" + brightness2 + "%) contrast(" + this.value + "%)";
    })
    slider6.addEventListener("input", function(e) {
      opacity2 = e.target.value;
      opacitySpan2.textContent = opacity2 + "%";
      topMap.getContainer().style.filter = "opacity(" + this.value + "%) brightness(" + brightness2 + "%) contrast(" + contrast2 + "%)";
    })

    //Create the opacity controls
    var higherOpacity = new L.Control.higherOpacity();
    map.addControl(higherOpacity);
    higherOpacity.setOpacityLayer(topMap);
    var lowerOpacity = new L.Control.lowerOpacity();
    map.addControl(lowerOpacity);
    lowerOpacity.setOpacityLayer(topMap);
    var opacitySlider = new L.Control.opacitySlider();
    map.addControl(opacitySlider);
    //specifies layer which opacity will be modified:
        opacitySlider.setOpacityLayer(topMap);
    //set initial opacity to 0.5
        //topMap.setOpacity(0.5);


    var overlays = {"Source Labels": sourcelabels,
                    "Annotations": drawnItems,
                    "Top Layer": topMap};
    L.control.layers(
      {'histo': histolayer},
      overlays, 
      { position: 'topleft', collapsed: true }).addTo(map);
    map.addControl(new L.Control.Draw({
        edit: {featureGroup: drawnItems,
            poly: {allowIntersection: false}
              },
        draw: {polygon: {allowIntersection: false,
                         showArea: true}
              }
    }));
    // load server data
    getJSONData("8888", drawnItems);

    // define event hooks to save data etc.
    map.on('draw:drawstart draw:editstart draw:deletestart', function (event){
      $("#serverstatus")[0].innerHTML = "NOT YET SAVED";
    });
    map.on('draw:created', function (event) {
      var layer = event.layer;
      drawnItems.addLayer(layer);
      postJSONData(JSON.stringify(drawnItems.toGeoJSON()), "8888");
    });
    map.on('draw:edited draw:deleted', function (event) {
      var layer = event.layer;
      postJSONData(JSON.stringify(drawnItems.toGeoJSON()), "8888");
    });
      
    // https://gis.stackexchange.com/questions/59571/how-to-add-text-only-labels-on-leaflet-map-with-no-icon
    //opacity may be set to zero for no marker
    var marker = new L.marker([-39.5, 50], { opacity: 0.2 }); 
    marker.bindTooltip("some histoname", {
      permanent: true, className: "my-label", offset: [0, 0] 
    });
    marker.addTo(sourcelabels);
    </script>
  </body>
</html>
